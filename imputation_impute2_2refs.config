config = ''


manifest {
    homePage = 'https://github.com/h3abionet/chipimputation/'
    description = ''
    mainScript = 'imputation.nf'
}

params {
    project                 = "qc_three_samples"
    // Directories
    // homedir: Path to your script, where the nextflow main script is located
    homedir                 = "${HOME}/chipdesign/imputation_chip_design"
    // outdir: where to put all pipeline's outputs
    scratch                 = "/researchdata/fhgfs/mamana"
    output_dir              = "${scratch}/AFRICA_CHIP/${project}"
    impute_result           = "${output_dir}/impute_results"
    scripts                 = "${params.homedir}/scripts"

    ref_panels {
        // ref_data_dir            = "${scratch}/AFRICA_CHIP/CHIP_FINAL_SET_SEPT_2016/REF_IMPUTE_H3A"
        // Reference panel 1
        ref_1 {
            dir               = "${scratch}/reference/REF_PANELS"
            name              = 'CBIO'
            hapFile           = "${ref_1.dir}/CBIO/HAP/h3a_chr%s.hap.gz"
            vcfFile           = "${ref_1.dir}/CBIO/VCF/h3a_chr%s.vcf.gz"
            legendFile        = "${ref_1.dir}/CBIO/HAP/h3a_chr%s.legend.gz"
            mapFile           = "${ref_1.dir}/1000G/MAP/genetic_map_chr%s_combined_b37.txt"
            sampleFile        = "${ref_1.dir}/CBIO/CBIO_updated.sample"
        }
        // Reference panel 2. Uncomment if you need two reference panels
//        ref_2 {
//            dir               = "${scratch}/reference/REF_PANELS"
//            name              = '1KG'
//            hapFile           = "${ref_2.dir}/1000G/HAP/1000GP_Phase3/1000GP_Phase3_chr%s.hap.gz"
//            vcfFile           = "${ref_2.dir}/1000G/VCF/1000GP_Phase3/ALL.chr%s.phase3_shapeit2_mvncall_integrated_v5a.20130502.genotypes.vcf.gz"
//            legendFile        = "${ref_2.dir}/1000G/HAP/1000GP_Phase3/1000GP_Phase3_chr%s.legend.gz"
//            mapFile           = "${ref_2.dir}/1000G/MAP/genetic_map_chr%s_combined_b37.txt"
//            sampleFile        = "${ref_2.dir}/1000G/HAP/1000GP_Phase3/1000GP_Phase3.sample"
//        }
        ref_2 {
            dir               = "${scratch}/reference/REF_PANELS"
            name              = 'H3A'
            hapFile           = "${ref_2.dir}/H3A/PHASED/HAP/Eagle.merged.%s_snpeff_dbsnp_anc_gwascat_clinvar_cosmic_mafs-ExAC-KG-agvp-gnomAD-sahgp-trypan_noRelated_noHighMiss_noALT.hap.gz"
            vcfFile           = "${ref_2.dir}/H3A/UNPHASED/VCF/h3a.non_sanger.cleaned.%s.vcf.gz"
            legendFile        = "${ref_2.dir}/H3A/PHASED/HAP/Eagle.merged.%s_snpeff_dbsnp_anc_gwascat_clinvar_cosmic_mafs-ExAC-KG-agvp-gnomAD-sahgp-trypan_noRelated_noHighMiss_noALT.legend"
            mapFile           = "${ref_2.dir}/1000G/MAP/genetic_map_chr%s_combined_b37.txt"
            sampleFile        = "${ref_2.dir}/H3A/PHASED/HAP/H3A.sample"
        }
    }

    tagSNPs_files{
//        MEGAv2                  = "${scratch}/AFRICA_CHIP/TAG/MEGA_Consortium_v2/MEGA_Consortium_v2_15070954_A2_chr%s.csv"
//        HumanOmni25             = "${scratch}/AFRICA_CHIP/TAG/HumanOmni2-5/HumanOmni2-5-8-v1-0-D_chr%s.csv"
//        AxiomGWPanAFRna35       = "${scratch}/AFRICA_CHIP/TAG/Axiom_GW_PanAFR_na35/Axiom_GW_PanAFR.na35.annot_chr%s.csv"
//        R7final                 = "${scratch}/AFRICA_CHIP/TAG/R7-final/R7-final.srt_chr%s.csv"
        H3AFRICAv1              = "${scratch}/AFRICA_CHIP/TAG/H3Africa_2017_20021485_A2_v1/H3Africa_2017_20021485_A2_v1_chr%s.csv"
    }

    dataset                     = "qc_three_samples"
    datasets{
//        MEGAv2                  = "${scratch}/AFRICA_CHIP/${dataset}/TAG_DATA/MEGAv2/VCF/MEGAv2_${dataset}_chr%s.vcf.gz"
//        HumanOmni25             = "${scratch}/AFRICA_CHIP/${dataset}/TAG_DATA/HumanOmni25/VCF/HumanOmni25_${dataset}_chr%s.vcf.gz"
//        AxiomGWPanAFRna35       = "${scratch}/AFRICA_CHIP/${dataset}/TAG_DATA/AxiomGWPanAFRna35/VCF/AxiomGWPanAFRna35_${dataset}_chr%s.vcf.gz"
//        R7final                 = "${scratch}/AFRICA_CHIP/${dataset}/TAG_DATA/R7final/VCF/R7final_${dataset}_chr%s.vcf.gz"
//        H3AFRICAv1              = "${scratch}/AFRICA_CHIP/${dataset}/TAG_DATA/H3AFRICAv1/VCF/H3AFRICAv1_${dataset}_chr%s.vcf.gz"
//        H3AFRICAv1              = "${scratch}/reference/REF_PANELS/qc_one_sample/H3AFRICAv1/VCF/AC01508GHA.unphased.%s_H3AFRICAv1_qc_one_sample_chr%s.vcf.gz"
        H3AFRICAv1              = "${scratch}/reference/test_data/qc_three_samples/H3AFRICAv1/VCF/threesamples.unphased.%s_H3AFRICAv1_qc_three_samples.vcf.gz"
    }

    result_files{
        impute                  = "${params.output_dir}/impute_results/impute/%s/%s/%s/threesamples.unphased.%s_%s_qc_three_samples_%s_phased.haps_%s-%s.imputed.gz"
        info                    = "${params.output_dir}/impute_results/impute/%s/%s/%s/threesamples.unphased.%s_%s_qc_three_samples_%s_phased.haps_%s-%s.imputed_info"
    }

    eagle_genetic_map       = "${scratch}/reference/eagle/tables/genetic_map_hg19_withX.txt.gz"

    // chunk size in base
    NE                      = "20000"
    impute_iter             = 30
    impute_burnin           = 10
    impute_info_cutoff      = "0.8"
    chunk_size              = "1000000"
    buffer_size             = "500"

    //chromosomes             = "ALL"
    chromosomes             = "1,2,3,4,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22"
    //chromosomes             = "21,22"

    // Plink QC parameters
    cut_mind                = "0.05"

    // Phasing method: shapeit (default) or eagle2
    phasing_method          = "eagle"

}


executor{
    jobName = { "$task.tag" }
}

profiles {
    // For execution on a local machine, no containerization. -- Default
    standard {
        process{
          executor        = 'local'
          cpus            = 1
          maxRetries      = 1
          maxErrors       = 10000
          errorStrategy   = 'retry'
        }
    }
    // For execution on a PBS scheduler, no containerization.
    pbs {
        process{
            executor        = 'pbs'
            queue           = 'UCTlong'
            time            = 4.h
            maxRetries      = 1
            maxErrors       = 10000
            cpus = { 3 * task.attempt }   
            //scratch         = 'true'
            errorStrategy   = 'retry'
            clusterOptions = " -M mbymam001@myuct.ac.za -m ae "
            scratch         = "${params.homedir}/"
            // errorStrategy   = { if (task.exitStatus == 143) { 'retry' } else if (task.exitStatus == 140 ) { 'retry' } else if (task.exitStatus == 137 ) { 'retry' } else { 'terminate' } }
            // TODO set scracth folder
//            errorStrategy = { task.exitStatus == 143 ? 'retry' : 'finish' }
//            withName: impute {
//                cpus = { 3 * task.attempt }
//            }
//            withName: phase_data {
//                cpus = { 10 * task.attempt }
//            }
        }
    }
}

workflow.onComplete = {
    println "========================================="
    println "Pipeline completed at: $workflow.complete"
    println "Execution status: ${ workflow.success ? 'OK' : 'failed' }"
}
